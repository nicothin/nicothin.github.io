---
layout:     post
title:      "Быстрота Linux на Windows 10"
subtitle:   "Ода bash-терминалу в Windows Subsystem for Linux"
date:       2018-07-19 16:23:19 +0300
permalink:  /page/:title
categories: web
---

Статья о настройке функциональности и внешнего вида bash-терминала Windows Subsystem for Linux (WSL) в Windows 10.

## Введение

Я постоянно использую терминал для работы с git и автоматизации сборки проектов (вёрстка/фронтенд: компиляция pug и scss, обработка изображений, транспиляция js...). На моём рабочем компьютере стоит Windows 10, а на ноутбуке — OSX и мне хочется использовать одни и те же консольные команды на обеих системах, поэтому я использовал GitBash (терминал, устанавливающийся вместе с Git) [внутри эмулятора (Cmder)](http://nicothin.pro/page/console-windows). Такая связка работала заметно медленнее терминала на OSX, поэтому я был воодушевлён новостью [«В Windows 10 встроили подсистему Linux»](https://habr.com/post/280560/) (март 2016 г.), но тогда, в 2016 году, её использование разочаровало: нельзя было запускать из bash-терминала программы Windows, подсистема не определяла изменение файла, если изменение было сделано из Windows. Сейчас эти проблемы решены.

### Спойлер

Главный выигрыш для меня — скорость. В моём стартовом репозитории есть трудоёмкая задача полной сборки проекта (компиляция, транспиляция, спрайты, шрифты, картинки...), с Gitbash она занимает 17 секунд, с bash-терминалом WSL — 10 секунд.

### Упоминаемые в статье файлы

*   [.bashrc](https://gist.github.com/nicothin/3438e083b171c390a34f89371da7ff4b)
*   [.dircolors](https://gist.github.com/nicothin/035bd9780f547c6f3798a3133b62bfbb)
*   [.bash_aliases](https://gist.github.com/nicothin/2a05b0dad3624f05d58292a856ec55ea)
*   [.inputrc](https://gist.github.com/nicothin/eab9236851295810c52fdc2c6f73f7d3)
*   [.vimrc](https://gist.github.com/nicothin/ec160dac386a42af422138814ea3f0cf)

## Установка Windows Subsystem for Linux (WSL)

В сети полно статей с инструкциями (по большей части, устаревших). Пользуйтесь [официальной инструкцией с docs.microsoft.com](https://docs.microsoft.com/ru-ru/windows/wsl/install-win10) и всё получится. Я установил Ubuntu, т.к. имею небольшой опыт ее использования.

После успешной установки можно запустить терминал подсистемы Linux командой `bash` в cmd.exe (или PowerShell) или кликом по иконке в меню «Пуск».

[![bash-терминал сразу после установки]({{ site.url }}/img/bash001.png)]({{ site.url }}/img/bash001.png)

## Основы использования терминала Ubuntu в Windows 10

Это **подсистема** внутри Windows, чтобы использовать nodeJS и git, нужно поставить их в подсистему (даже если они уже установлены в Windows). Я выбрал вариант с Ubuntu, поэтому при установке nodejs пользовался [этой инструкцией](https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions), а git установил командой `sudo apt-get install git` (не забудьте указать git-у своё имя пользователя и email).

Можно запускать приложения Windows. Попробуйте `notepad.exe` — запустится Windows-блокнот.

Диски Windows расположены в `/mnt/` . Попробуйте `cd /mnt/c/ && ls` для перехода к диску `С:/` и вывода его корневых директорий (по умолчанию вывод выглядит уныло, но это настраивается).

Директория пользователя расположена в `~` (`cd ~` для переходя в неё). Просто напоминаю.

В Linux-системах заглавные и строчные символы — разные символы. При использовании автодополнения (`Tab` ) важно вводить символы в правильном регистре.

Директория пользователя подсистемы Linux физически у меня расположилась в `c:\Users\nicothin\AppData\Local\Packages\CanonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc\LocalState\rootfs\home\nicothin\`, где `nicothin` — имя пользователя системы (как в начале пути (Windows), так и в конце (Ubuntu)).

Если редактировать файлы Linux-подсистемы из Windows, то Linux в некоторых случаях не сможет получить к ним доступ (не хватит прав). После такого редактирования нужно в bash-терминале подсистемы выполнить что-то вроде `chmod 777 ~/.bashrc` (где `~/.bashrc` — редактированный из Windows файл) и перезапустить терминал. Или можно использовать команду `source ~/.bashrc` (укажите редактированный файл) для применения внесённых изменений.

### Как запускать Sublime Text из консоли Ubuntu

Если используете Sublime Text, добавьте путь к subl.exe в [PATH](https://ru.wikipedia.org/wiki/PATH_(%D0%BF%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F)) в Windows, чтобы по команде в терминале `subl.exe` запускался Sublime Text:

1.  В проводнике сделайте правый клик на **Этот компьютер**, выберите **Свойства**, потом **Дополнительные параметры системы**.
2.  На вкладке **Дополнительно** нажмите кнопку **Переменные среды**.
3.  Сделайте двойной клик по **Path** для перехода к её редактированию.
4.  Нажмите кнопку **Создать** и добавьте путь к subl.exe.
    В моем случае это `c:\Program Files\Sublime Text 3\`.
5.  Перезапустите терминал.

[![Как добавить вызов Sublime Text из консоли]({{ site.url }}/img/bash-path.png)]({{ site.url }}/img/bash-path.png)

## Настройка консоли Ubuntu

### Цвета

Увы, сразу после установки консоль (особенно вывод команды `ls` ) выглядит «бородато» и «носит свитер».

[![bash-терминал WSL по умолчанию]({{ site.url }}/img/bash-colors-01.png)]({{ site.url }}/img/bash-colors-01.png)

Можно добавить файл с настройками цветового оформления (`touch ~/.dircolors` для создания файла) с [этим содержимым](https://gist.github.com/nicothin/035bd9780f547c6f3798a3133b62bfbb).

Содержимое удобно добавлять из Windows, но тогда после сохранения файла в bash-терминале выполните `chmod 777 ~/.dircolors` и перезапустите терминал.

[![bash-терминал WSL после настройки цветов директорий и файлов]({{ site.url }}/img/bash-colors-02.png)]({{ site.url }}/img/bash-colors-02.png)

### Переход к нужной директории при старте

Если при запуске терминала хочется попадать в директорию проектов, можно вписать в самом верху `~/.bashrc` команду `cd /mnt/d/projects/` (укажите путь к нужной директории).

### Алиасы

Добавим файл (`touch ~/.bash_aliases` ) c [этим содержимым](https://gist.github.com/nicothin/2a05b0dad3624f05d58292a856ec55ea) и перезапустим bash-терминал.

Теперь по команде `subl .` откроется Sublime Text (текущая папка будет показана как проект), а по команде наподобие `subl filename.txt` можно быстро открывать файлы.

#### Странная проблема с алиасами

Я настраивал bash-терминал на двух домашних компьютерах с Windows 10 и на одном из них после добавления файла терминал при рестарте выводил 4 сообщения `: command not found` . Из-за чего — я так и не понял (права доступа были и владелец файла — я), но нашел строки в `~/.bashrc` , которые к этому приводили. Это было подключение файла с алиасами:

```bash
if \[ -f ~/.bash_aliases \]; then
    . ~/.bash_aliases
fi
```

Решил проблему, закомментировав эти строки и вписав алиасы прямо в `~/.bashrc` (в самом низу).

### Показ git-ветки в командной строке

Шаг 1: добавим в начале `~/.bashrc` функцию для показа ветки:

```bash
git_branch() {
  git branch 2> /dev/null | sed -e '/^\[^*\]/d' -e 's/* (.*)/(\\1)/'
}
```

Шаг 2: определим переменную, отвечающую за приглашение командной строки, добавим в неё показ результата работы этой функции (см. [`.bashrc`](https://gist.github.com/nicothin/3438e083b171c390a34f89371da7ff4b) ). Получится что-то вроде:

```bash
if \[ "$color_prompt" = yes \]; then
    PS1='${debian\_chroot:+($debian\_chroot)}\\\[\\033\[32m\\\]\\u@\\h\\\[\\033\[00m\\\]:\\\[\\033\[01;37m\\\]\\w\\\[\\033\[00m\\\] \\e\[32m$(git_branch)\\e\[0m $ '
else
    PS1='${debian\_chroot:+($debian\_chroot)}\\u@\\h:\\w\ \\e\[32m$(git_branch)\\e\[0m $ '
fi
```

### Мелкие улучшения

Есть довольно много действий в bash-терминале, на которые Windows 10 отреагирует звуковым сигналом (нажатие `Backspace` , когда уже нечего стирать, например). Чтобы это отключить, создайте `~/.inputrc` со строкой `set bell-style none` .

[Vim](https://ru.wikipedia.org/wiki/Vim) по умолчанию показывает довольно тёмный текст, что на тёмном фоне смотрится плохо. Можно создать `~/.vimrc` со строкой `set background=dark` , чтобы текст стал более читаемым.

## Замеченные баги

Работать с буфером обмена по умолчанию не комфортно (`Ctrl + V` , `Shift + Insert` не работают, приходится кликать (!!!) ПКМ по заголовку окна и выбирать **Изменить** → **Вставить**). Решается использованием терминала не самостоятельно, а внутри Cmder.

Несколько раз видел странный глюк отображения многострочной команды: как будто символы второй строки не перенеслись, а печатаются в первой строке. Редко, не критично.

На одном из домашних компьютеров работает сохранение истории команд между сеансами, на другом не работает (хотя права доступа и владелец файла `~/.bash_history` — активный пользователь и сохранение истории включено). Не критично.

## Комфортное использование с Cmder

Для более тонкой настройки внешнего вида и комфортной работы с буфером обмена (привычное сочетание `Ctrl + V` для вставки) удобно использовать bash-терминал подсистемы Linux внутри [cmder](http://cmder.net/) (эмулятор терминала, внутри которого можно запустить один из установленных в Windows терминалов). Для этого нужно добавить возможность старта WSL-консоли в настройках Сmder:

1.  Правый клик по иконке бургера в нижнем правом углу для перехода к настройкам.
2.  В разделе **Startup** выбрать радиокнопку **Auto save/restore opened tabs**, чтобы при рестарте не создавать вкладки заново.
3.  В разделе **Startup**, подразделе **Tasks** проверить наличие задачи **WSL::bash**. Если её нет, нажать кнопку **Add/refresh default tasks...** и согласиться на добавление задач.
4.  В списке задач появится пункт **WSL::bash**, при создании новой вкладки терминала нужно выбрать его.

[![bash-терминал внутри cmder]({{ site.url }}/img/bash-result.png)]({{ site.url }}/img/bash-result.png)

Если в списке задач есть пункт **WSL::bash**, но WSL не запускается при его выборе (в момент создания новой вкладки Cmder), то в настройках можно попробовать нажать **Add/refresh default tasks...** и согласиться на обновление списка задач (см. п. 3). Если и после этого не получается запустить терминал подсистемы (Cmder сообщает о проблеме и пишет, что по нажатию Enter закроет вкладку), то можно добавить свою собственную задачу, которая будет запускать cmd.exe и сразу вызывать в ней команду `bash` . Команда запуска терминала будет выглядеть так:

```bash
*cmd /k ""%ConEmuDir%..init.bat" " && bash
```

[![Запуск bash-терминала командой bash в cmd.exe]({{ site.url }}/img/bash-winbuntu.png)]({{ site.url }}/img/bash-winbuntu.png)

## Вместо заключения

Я скачал и установил в систему шрифт [Ubuntu Mono](https://fonts.google.com/specimen/Ubuntu+Mono) для большей аутентичности внешнего вида терминала.

## P.S.

HYPERCOMMENTS, который я использовал для комментирования на страницах своего блога, убрал бесплатный аккаунт, так что комментарии временно недоступны.
